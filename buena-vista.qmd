# Buena Vista

```{r}
#| label: setup

library(tidyverse)
library(hdatools)
library(scales)
library(sf)
library(mapview)
library(leaflet)
library(kableExtra)
library(htmltools)
library(htmlwidgets)

# Set color scales

allowance_cols <- c(
  "Allowed" = "#259591", 
  "Conditional" = "#8b85ca", 
  "Special Exemption" = "#e0592a",
  "Prohibited" = "#b1005f"
  )

allowance_pal <- colorFactor(
  palette = c(
    "#259591", 
    "#8b85ca", 
    "#e0592a"
  ),
  levels = c(
    "Allowed", 
    "Conditional", 
    "Special Exemption"
  )
)

zoning_cols <- c(
  "B1" = "#FFB6C1",    # Light pink for General Business
  "B2" = "#FF69B4",    # Darker pink for Planned Business
  "C1" = "#90EE90",    # Light green for Conservation
  "GM" = "#B0C4DE",    # Light steel blue for General Manufacturing
  "INST" = "#D3D3D3",  # Light gray for Institutional
  "LM" = "#00BFFF",    # Deep sky blue for Light Manufacturing
  "MB" = "#DDA0DD",    # Plum for Mixed Business
  "MU" = "#DA70D6",    # Orchid for Mixed Use
  "MUC" = "#9370DB",   # Medium purple for Mixed Use Corridor
  "MXB-HT" = "#663399", # Dark purple for Mixed Use Business - Hill Top
  "PUD-R6" = "#FFA07A", # Light salmon for PUD-Residential
  "PUD-RES-HT" = "#A0522D", # Sienna for PUD-Residential-Hilltop
  "R1" = "#FFFFD4",    # Very light yellow for Low Density Residential
  "R2" = "#FFFF00",    # Yellow for Residential
  "R3" = "#FFE4B5",    # Moccasin for Residential Limited
  "R4" = "#FFA500",    # Orange for Medium Density Residential
  "REC" = "#98FB98"    # Pale green for Recreational
)

zoning_pal <- colorFactor(
  palette = zoning_cols,
  domain = names(zoning_cols)
)

```

This section examines current residential zoning patterns in the City of Buena Vista.

The existing zoning ordinance dictating land use and development was originally written in 1985. It has not been comprehensively rewritten since then. At that time, the city's population was 6,470---only about 100 people less than its population today.

Since 1985, amendments have been made to the zoning code to address cases and uses not originally considered, but the overall form of the zoning code remains unchanged.

```{r}

# Load BV zoning and parcel data

bv_districts <- read_csv("data/buena-vista/bv-zoning-districts.csv")
bv_zoning <- read_rds("data/buena-vista/bv_zoning.rds")
bv_parcels <- read_rds("data/buena-vista/bv_parcels.rds")

```

## Zoning districts

. . .

```{r}
#| label: tbl-zoning-districts
#| tbl-cap: "Zoning districts in Buena Vista"

bv_districts |> 
  select(zone, name, overlay, type) |> 
  kable(
    col.names = c("Zone", "Name", "Overlay", "Type"),
    align = "clll"
    ) |>
  kableExtra::kable_styling(
    bootstrap_options = c("hover", "condensed", "responsive")
    )

```

. . .

```{r}

zoning_pal <- colorFactor(rainbow(20), unique(bv_parcels$ZONING))

bv_zoning_map <- leaflet(filter(bv_parcels, ZONING != "NA")) |> 
  addProviderTiles(providers$CartoDB.Positron) |> 
  addPolygons(fillColor = ~zoning_pal(ZONING),
              fillOpacity = 0.7,
              weight = 0) |> 
  addLegend("topright",
            pal = zoning_pal,
            values = ~ZONING,
            title = "Zoning")

saveWidget(bv_zoning_map, "maps/bv_zoning_map.html")

bv_zoning_map


```

. . .

```{r}
#| label: tbl-residential-uses
#| tbl-cap: "Residential use allowances"

bv_districts |> 
  filter(overlay == "No",
         type != "Nonresidential") |> 
  mutate(
    across(
      c(6:13),
      ~ case_match(
        .x,
        "Prohibited" ~ "P",
        "Allowed" ~ "A",
        "Conditional" ~ "C",
        "Special Exception" ~ "S"
      )
      )
    ) |> 
  mutate(
    across(
      c(6:13),
      ~ cell_spec(
        .x,
        bold = TRUE,
        color = case_match(
          .x,
          "P" ~ "#b1005f",
          "A" ~ "#259591",
          "C" ~ "#8b85ca",
          "S" ~ "#e0592a"
        )
      )
    )
  ) |>
  select(1, 6:13) |> 
  kable(
    col.names = c("Zone", "SF detached", "Townhome", "Duplex", "Multifamily", "Group Home", "ADU", "MH", "MHP"),
    align = "lcccccccc",
    escape = FALSE
    ) |>
  kableExtra::kable_styling(
    bootstrap_options = c("hover", "condensed", "responsive")
    )

```

## Lot requirements

. . .

```{r}

# https://library.municode.com/va/buena_vista/codes/code_of_ordinances?nodeId=PTIIILADERE_ART6USDI_S630.00TASE


```

## Distribution

. . .

```{r}
#| label: bv-dist-zoning

bv_zoning_area <- bv_parcels |> 
  st_drop_geometry() |> 
  group_by(ZONING) |> 
  summarise(acres = sum(acres),
            parcels = n()) |> 
  ungroup() |> 
  mutate(pct_parcels = parcels/sum(parcels),
         pct_area = acres/sum(acres))


```

## Land use by district

The charts below show how parcels within each of the City's zoning districts are currently used. 
